package glui

import (
	"github.com/go-gl/glfw/v3.3/glfw"
	"math"
)

const (
	DefaultClickLimit = 2
)

var (
	ClickLimit float64 = DefaultClickLimit // Max allowed distance between press and release
)

// MouseClickListener adds some processing to the mouse button press and release events generated by glfw
// to turn them into single click events at the point the button was first pressed.
type MouseClickListener struct {
	Window    *GLWin
	Button    glfw.MouseButton
	Point     []float64
	Observers []func(point []float64)
}

// NewMouseClickListener adds a listener to the supplied window for the indicated button,
// and the function to be called when a click is detected.
func NewMouseClickListener(win *GLWin, button glfw.MouseButton, onClick func([]float64)) *MouseClickListener {
	res := &MouseClickListener{win, button, nil, []func([]float64){onClick}}
	win.Win.SetMouseButtonCallback(func(w *glfw.Window, but glfw.MouseButton, act glfw.Action, mods glfw.ModifierKey) {
		if but != res.Button {
			return
		}
		if act == glfw.Press {
			x, y := w.GetCursorPos()
			res.Point = []float64{x, y}
		} else if act == glfw.Release {
			if res.Point == nil {
				return
			}
			// Check release point is within thresh of res.Point
			x, y := w.GetCursorPos()
			dx, dy := res.Point[0]-x, res.Point[1]-y
			d := math.Hypot(dx, dy)
			if d > ClickLimit {
				res.Point = nil
				return
			}
			// Call observers with mouse click
			for _, ocf := range res.Observers {
				if ocf == nil {
					continue
				}
				ocf(res.Point)
			}
			res.Point = nil
		}
	})
	return res
}
